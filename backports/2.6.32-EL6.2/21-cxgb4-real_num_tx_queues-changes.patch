From ce0bbdee8fe4ac34ad0b695f914c499b5ebeae3f Mon Sep 17 00:00:00 2001
From: Vipul Pandya <vipul@chelsio.com>
Date: Thu, 10 May 2012 17:51:16 +0530
Subject: [PATCH 13/14] cxgb4: real_num_tx_queues changes

Signed-off-by: Vipul Pandya <vipul@chelsio.com>
---
 drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c |    3 ++-
 drivers/net/ethernet/chelsio/cxgb4/t4_hw.c      |    2 +-
 2 files changed, 3 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c b/drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
index 49da127..a669aad 100644
--- a/drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
+++ b/drivers/net/ethernet/chelsio/cxgb4/cxgb4_main.c
@@ -3462,7 +3462,7 @@ static void __devinit enable_pcie_relaxed_ordering(struct pci_dev *dev)
 	u16 v;
 	int pos;

-	pos = pci_pcie_cap(dev);
+	pos = pci_find_capability(dev, PCI_CAP_ID_EXP);
 	if (pos > 0) {
 		pci_read_config_word(dev, pos + PCI_EXP_DEVCTL, &v);
 		v |= PCI_EXP_DEVCTL_RELAX_EN;
@@ -3654,6 +3654,7 @@ static int __devinit init_one(struct pci_dev *pdev,
 	 */
 	for_each_port(adapter, i) {
 		pi = adap2pinfo(adapter, i);
+		adapter->port[i]->real_num_tx_queues = pi->nqsets;
 		netif_set_real_num_tx_queues(adapter->port[i], pi->nqsets);
 		netif_set_real_num_rx_queues(adapter->port[i], pi->nqsets);

diff --git a/drivers/net/ethernet/chelsio/cxgb4/t4_hw.c b/drivers/net/ethernet/chelsio/cxgb4/t4_hw.c
index d1ec111..8147917 100644
--- a/drivers/net/ethernet/chelsio/cxgb4/t4_hw.c
+++ b/drivers/net/ethernet/chelsio/cxgb4/t4_hw.c
@@ -2685,7 +2685,7 @@ static void __devinit get_pci_mode(struct adapter *adapter,
 				   struct pci_params *p)
 {
 	u16 val;
-	u32 pcie_cap = pci_pcie_cap(adapter->pdev);
+	u32 pcie_cap = pci_find_capability(adapter->pdev, PCI_CAP_ID_EXP);

 	if (pcie_cap) {
 		pci_read_config_word(adapter->pdev, pcie_cap + PCI_EXP_LNKSTA,
--
1.7.1

